# Develop GenAI Apps with Gemini and Streamlit: Challenge Lab

[GSP363](https://www.cloudskillsboost.google/focuses/87315?parent=catalog)

## Task 1. Use cURL to test a prompt with the API

1. In the Google Cloud console, on the Navigation menu, click Vertex AI > Workbench.
2. Find the `Workbench instance name` instance and click on the Open JupyterLab button.
3. From the left hand menu, open `prompt-vx.y.z.ipynb`.
4. Choose python3, and then execute the first two cells.
5. Include your `PROJECT_ID` and `REGION` within cell 3. You can get this in the left panel of the lab instructions.

    ```python
    # Task 1.3
    # Modify these variables to include your project ID and region.
    PROJECT_ID = "[your-project-id]"  # @param {type:"string"}
    LOCATION = "[your-region]"  # @param {type:"string"}

    # Create the API client
    from google import genai
    client = genai.Client(vertexai=True, project=PROJECT_ID, location=LOCATION)
    ```

6. Execute cell 4 and then modify cell 5, by replacing the existing prompt.

    ```python
    %%bash

    # Task 1.4
    # Use cURL to test a prompt with the API, by modifying prompt with the prompt from the lab guide.

    MODEL_ID="gemini-2.0-flash-001"

    curl -X POST \
      -H "Authorization: Bearer $(gcloud auth print-access-token)" \
      -H "Content-Type: application/json" \
      https://${API_ENDPOINT}/v1/projects/${PROJECT_ID}/locations/${LOCATION}/publishers/google/models/${MODEL_ID}:streamGenerateContent \
      -d '{
        "contents": {
          "role": "USER", 
          "parts": { "text": "I am a Chef.  I need to create Japanese recipes for customers who want low sodium meals. However, I do not want to include recipes that use ingredients associated with a peanuts food allergy. I have ahi tuna, fresh ginger, and edamame in my kitchen and other ingredients. The customer wine preference is red. Please provide some for meal recommendations. For each recommendation include preparation instructions, time to prepare and the recipe title at the begining of the response. Then include the wine paring for each recommendation. At the end of the recommendation provide the calories associated with the meal and the nutritional facts." }
        }
      }'
    ```

## Task 2. Write Streamlit framework and prompt Python code to complete chef.py

1. Using Cloud Shell clone the repo below from the default directory.

    ```bash
    git clone https://github.com/GoogleCloudPlatform/generative-ai.git
    ```

2. Navigate to the `gemini-streamlit-cloudrun` directory.

    ```bash
    cd generative-ai/gemini/sample-apps/gemini-streamlit-cloudrun
    ```

3.Specify the dependency `google-cloud-logging` in the `requirements.txt` file.

    ```text
    streamlit
    google-genai
    google-cloud-logging
    ```

4. Download the `chef.py` file

    ```bash
    gsutil cp gs://<your project>-gemini/chef.py .
    ```

5. Open `chef.py` file in Cloud Shell editor (in `generative-ai/gemini/sample-apps/gemini-streamlit-cloudrun`and replace `PROJECT_ID` and `REGION`

    ```python
    PROJECT_ID = "[your-project-id]"  # Your Google Cloud Project ID
    LOCATION = "[your-region]"  # Your Google Cloud Project Region
    ```

6. Edit `chef.py` and add Streamlit framework radio button option for the wine variable. **Save**.

    ```python
    # Task 2.5
    # Complete Streamlit framework code for the user interface, add the wine preference radio button to the interface.
    # https://docs.streamlit.io/library/api-reference/widgets/st.radio

    wine = st.radio (
        "What wine do you prefer?\n\n", ["Red", "White", "None"], key="wine", horizontal=True
    )
    ```

7. Add the new Gemini prompt below in Python code. **Save**.

    ```python
    # Task 2.8
    # Modify this prompt with the custom chef prompt.
    prompt = f"""I am a Chef.  I need to create {cuisine} \n
    recipes for customers who want {dietary_preference} meals. \n
    However, don't include recipes that use ingredients with the customer's {allergy} allergy. \n
    I have {ingredient_1}, \n
    {ingredient_2}, \n
    and {ingredient_3} \n
    in my kitchen and other ingredients. \n
    The customer's wine preference is {wine} \n
    Please provide some for meal recommendations.
    For each recommendation include preparation instructions,
    time to prepare
    and the recipe title at the beginning of the response.
    Then include the wine paring for each recommendation.
    At the end of the recommendation provide the calories associated with the meal
    and the nutritional facts.
    """
    ```

8. In Cloud Shell, upload the file. `<storage-id>` will be provided at lab start.

    ```bash
    gcloud storage cp chef.py gs://<storage-id>-generative-ai/
    ```

## Task 3. Test the application

1. Open Cloud Shell
2. Make sure you are in the path `generative-ai/gemini/sample-apps/gemini-streamlit-cloudrun`
3. Setup the python virtual environment and install the dependencies.

    ```bash
    python3 -m venv gemini-streamlit
    source gemini-streamlit/bin/activate
    python3 -m  pip install -r requirements.txt
    ```

4. Set environment variables for `PROJECT` (as your Project ID) and `REGION` (as the region you are using in the lab environment).

    ```bash
    export PROJECT=`gcloud config get-value project`
    export REGION='[put your region]'
    ```

5. Run the chef.py application and test it.

    ```bash
    streamlit run chef.py \
    --browser.serverAddress=localhost \
    --server.enableCORS=false \
    --server.enableXsrfProtection=false \
    --server.port 8080
    ```

## Task 4. Modify the Dockerfile and push image to the Artifact Registry

1. Use the Cloud Shell editor to modify the Dockerfile to use chef.py, then save the file.

    ```docker
    FROM python:3.12-slim

    EXPOSE 8080
    WORKDIR /app

    COPY . ./

    RUN pip install -r requirements.txt

    ENTRYPOINT ["streamlit", "run", "chef.py", "--server.port=8080", "--server.address=0.0.0.0"]
    ```

2. In Cloud Shell set the environment variables.

    ```bash
    AR_REPO='chef-repo'
    SERVICE_NAME='chef-streamlit-app' 
    ```

3. Create the Artifact Registry repository with the `gcloud artifacts repositories` create command.

    ```bash
    gcloud artifacts repositories create "$AR_REPO" --location="$REGION" --repository-format=Docker
    ```

4. Submit the build with the `gcloud builds submit` command. Wait for the command to complete.

    ```bash
    gcloud builds submit --tag "$REGION-docker.pkg.dev/$PROJECT/$AR_REPO/$SERVICE_NAME"
    ```

## Task 5. Deploy the application to Cloud Run and test

1. In Cloud Shell deploy the application (as a Docker Artifact), using `gcloud run deploy` command.

    ```bash
    gcloud run deploy "$SERVICE_NAME" \
    --port=8080 \
    --image="$REGION-docker.pkg.dev/$PROJECT/$AR_REPO/$SERVICE_NAME" \
    --allow-unauthenticated \
    --region=$REGION \
    --platform=managed  \
    --project=$PROJECT \
    --set-env-vars=GCP_PROJECT=$PROJECT,GCP_REGION=$REGION
    ```

2. Test the application with the link provided.