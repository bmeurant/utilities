# Deploy and Manage Apigee X: Challenge Lab

[GSP349](https://www.cloudskillsboost.google/focuses/20940?parent=catalog)

## Task 1. Modify the environments and environment groups

1. Create a **staging** environment
   - Navigate to [Apigee UI](https://console.cloud.google.com/apigee/overview/) in the Cloud console.
   - On the left navigation menu, select **Management > Environments**.
   - In the **Environments** tab, click **+ Create Environment**.
   - Specify **staging** for **Display name** and **Name**. Other fields should remain unchanged.
   - Click **Create**.

2. Create a **staging-group** environment group

   - On the left navigation menu, select **Management > Environments**.
   - In the Environments pane, select **Environment Groups** and click **+ Create Environment Group**.
   - Name the environment group **staging-group**.
   - Provide **staging.example.com** as the hostname for the newly created environment group.
   - For the **Environments (Optional)** select **staging** and click **Ok**.
   - Click **Create**.   

## Task 2. Use the provisioning wizard to set up access routing

1. Set up **Access Routing**
   - Return to the **[wizard](https://console.cloud.google.com/apigee/setup/eval)** Setup tab.
   - Next to **Access routing**, click **Edit**.
   - Select **Enable internet access**.
   - Select **Use wildcard DNS service**.
   - To use the default wildcard DNS provider, nip.io, leave the **domain** unchanged.
   - For **Subnetwork**, select **api-subnet**.
   - Click **Set Access** and wait until the access routing configuration has completed. 
   - Copy the Domain (ex: `1.2.3.4.nip.io`)

2. Test the API
   - Run this command:

      ```bash
      curl -i "https://<domain>/hello-world"
      ```

      replace <domain> with the copied domain name

    - The response should look similar to this:

      ```text
      HTTP/2 200 
      x-powered-by: Apigee
      access-control-allow-origin: *
      x-frame-options: ALLOW-FROM RESOURCE-URL
      x-xss-protection: 1
      x-content-type-options: nosniff
      content-type: text/plain; charset=utf-8
      content-length: 13
      etag: W/"d-CD90h6x0eIVqiTkn8InWaeagV3Q"
      date: Wed, 24 Sep 2025 20:15:11 GMT
      alt-svc: h3=":443"; ma=2592000,h3-29=":443"; ma=2592000
      alt-svc: h3=":443"; ma=2592000,h3-29=":443"; ma=2592000
      x-request-id: 8385db97-d052-4ce6-a85a-d6c2cc2c9048
      via: 1.1 google, 1.1 google
      ```

## Task 3. Create and activate a NAT address for the instance

1. Create a **NAT address**

   - Copy the following Google API Explorer link and paste it in a new tab of your browser window for the Google Cloud Console: [Google APIs Explorer for the Apigee API](https://cloud.google.com/apigee/docs/reference/apis/apigee/rest).
   - In the left pane, expand the **organizations.instances.natAddresses** section.
   - Under **organizations.instances.natAddresses**, click **create**.
   - In the **Try this API** pane, set the **parent** to:

     ```text
     organizations/PROJECT/instances/eval-instance
     ```

     replace `PROJECT` with your project id

   - Click **Add request body parameters**, and then click **name**.
   - Between the double quotes, set the string to **apigee-nat-ip**.
   - Click **Execute**.

     If a window pops up and asks you to choose an account to continue to the Google API Explorer, select your lab username, and then click **Allow**.

   - The API response should resemble this:

     ```json
     {
       "name": "organizations/qwiklabs-gcp-00-1f17b0a3b9f9/operations/cfc120b4-c9e6-4ab7-9e73-50dde14f2a86",
       "metadata": {
         "@type": "type.googleapis.com/google.cloud.apigee.v1.OperationMetadata",
         "operationType": "INSERT",
         "targetResourceName": "organizations/qwiklabs-gcp-00-1f17b0a3b9f9/instances/eval-instance/natAddresses/apigee-nat-ip",
         "state": "IN_PROGRESS"
       }
     }
     ```

   - In the left pane, under **organizations.instances.natAddresses**, click **get**.
   - In the **Try this API** pane, set the **parent** to:

     ```text
     organizations/PROJECT/instances/eval-instance/natAddresses/apigee-nat-ip
     ```

     replace `PROJECT` with your project id

   - Click **Execute**.

     If a window pops up and asks you to choose an account to continue to the Google API Explorer, select your lab user, and then click **Allow**.

   - The API response should resemble this:

     ```json
     {
       "name": "apigee-nat-ip",
       "ipAddress": "34.6.98.218",
       "state": "RESERVED"
     }
     ```

2. Activate the **NAT address**

    - In the left pane, under **organizations.instances.natAddresses**, click **activate**.
    - In the **Try this API** pane, set the **parent** to:

      ```text
      organizations/PROJECT/instances/eval-instance/natAddresses/apigee-nat-ip
      ```

     replace `PROJECT` with your project id

    - Click **Execute**.

     If a window pops up and asks you to choose an account to continue to the Google API Explorer, select your lab user, and then click **Allow**.

    - The API response should resemble this:

      ```json
      {
        "name": "organizations/qwiklabs-gcp-00-1f17b0a3b9f9/operations/4dd0f78a-f2e5-4a77-bc90-6a0b53bf9bff",
        "metadata": {
          "@type": "type.googleapis.com/google.cloud.apigee.v1.OperationMetadata",
          "operationType": "INSERT",
          "targetResourceName": "organizations/qwiklabs-gcp-00-1f17b0a3b9f9/instances/eval-instance/natAddresses/apigee-nat-ip",
          "state": "IN_PROGRESS"
        }
      }
      ```

    - In the left pane, under **organizations.instances.natAddresses**, click **get**.
   - In the **Try this API** pane, set the **parent** to:

     ```text
     organizations/PROJECT/instances/eval-instance/natAddresses/apigee-nat-ip
     ```

     replace `PROJECT` with your project id

   - Click **Execute**.

     If a window pops up and asks you to choose an account to continue to the Google API Explorer, select your lab user, and then click **Allow**.

   - The API response should resemble this:

     ```json
     {
       "name": "apigee-nat-ip",
       "ipAddress": "34.6.98.218",
       "state": "ACTIVE"
     }
     ```

## Task 4. Create a Cloud Armor security policy and attach it to the global load balancer

1. Create the **Cloud Armor policy**

   - In the Cloud Console tab, on the Navigation menu, click **View all Products**, then select **Network security** in the **Networking** section, and then navigate to **Cloud Armor policies**.
   - Click **Create policy**.
   - For Name, specify **protect-apigee**.
   - For **Default rule action**, select **Allow**.
   - Click **Next Step**.

2. Add a rule to block Remote Code Execution attacks

   - Click **Add a Rule**.
   - Click **Advanced mode**.
   - For **Match**, specify the following expression:

     ```text
     evaluatePreconfiguredExpr('rce-stable')
     ```
   - Leave Action set to **Deny**, and leave **Deny status** set to **403 (Forbidden)**.
   - Set **Priority** to `1000`.
   - Click **SAVE CHANGE TO RULE**.
   - Click **Create policy**.

3. Attach the policy to the load balancer

    - Next to **protect-apigee**, click the policy menu button, and then click **Apply policy to target**.
    - For the Backend Service 1 dropdown, select apigee-proxy-backend, and then click **Add**.

4. Test the API
   - Run this command:

      ```bash
      curl -i "https://${SSL_HOSTNAME}/hello-world?doc=/bin/ls
      ```

    - The response should look similar to this:

      ```text
      HTTP/2 403 
      content-length: 134
      content-type: text/html; charset=UTF-8
      date: Wed, 24 Sep 2025 20:29:10 GMT
      alt-svc: h3=":443"; ma=2592000,h3-29=":443"; ma=2592000

      <!doctype html><meta charset="utf-8"><meta name=viewport content="width=device-width, initial-scale=1"><title>403</title>403 Forbidden
      ```

## Task 5. Attach the staging environment to the runtime instance

1. Use the following Cloud Shell script to confirm that the Apigee runtime is completely installed and wait for `ORG IS READY TO USE`.

   ```bash
   export INSTANCE_NAME=eval-instance; export ENV_NAME=eval; export PREV_INSTANCE_STATE=; echo "waiting for runtime instance ${INSTANCE_NAME} to be active"; while : ; do export INSTANCE_STATE=$(curl -s -H "Authorization: Bearer $(gcloud auth print-access-token)" -X GET "https://apigee.googleapis.com/v1/organizations/${GOOGLE_CLOUD_PROJECT}/instances/${INSTANCE_NAME}" | jq "select(.state != null) | .state" --raw-output); [[ "${INSTANCE_STATE}" == "${PREV_INSTANCE_STATE}" ]] || (echo; echo "INSTANCE_STATE=${INSTANCE_STATE}"); export PREV_INSTANCE_STATE=${INSTANCE_STATE}; [[ "${INSTANCE_STATE}" != "ACTIVE" ]] || break; echo -n "."; sleep 5; done; echo; echo "instance created, waiting for environment ${ENV_NAME} to be attached to instance"; while : ; do export ATTACHMENT_DONE=$(curl -s -H "Authorization: Bearer $(gcloud auth print-access-token)" -X GET "https://apigee.googleapis.com/v1/organizations/${GOOGLE_CLOUD_PROJECT}/instances/${INSTANCE_NAME}/attachments" | jq "select(.attachments != null) | .attachments[] | select(.environment == \"${ENV_NAME}\") | .environment" --join-output); [[ "${ATTACHMENT_DONE}" != "${ENV_NAME}" ]] || break; echo -n "."; sleep 5; done; echo "***ORG IS READY TO USE***";
   ```

2. To begin the process of attaching the prod environment to the runtime, run the following command:

   ```bash
   export INSTANCE_NAME=eval-instance; curl -s -H "Authorization: Bearer $(gcloud auth print-access-token)" -H "Content-Type: application/json" -X POST "https://apigee.googleapis.com/v1/organizations/${GOOGLE_CLOUD_PROJECT}/instances/${INSTANCE_NAME}/attachments" -d '{ "environment": "staging" }' | jq
   ```

   When you have successfully begun the process of attaching the prod environment to the runtime, you should see a return message with a state of IN_PROGRESS looking similar to this:

   ```json
   {
     "name": "organizations/qwiklabs-gcp-00-1f17b0a3b9f9/operations/e500ad40-2c9a-4fbf-a7c6-431539d59484",
     "metadata": {
       "@type": "type.googleapis.com/google.cloud.apigee.v1.OperationMetadata",
       "operationType": "INSERT",
       "targetResourceName": "organizations/qwiklabs-gcp-00-1f17b0a3b9f9/instances/eval-instance/attachments/95bb11cc-a189-4f79-874a-5a98be92a2fa",
       "state": "IN_PROGRESS"
     }
   }
   ```

3. Check the status of the staging attachment using this command:

   ```bash
   export ATTACHING_ENV=staging; export INSTANCE_NAME=eval-instance; echo "waiting for ${ATTACHING_ENV} attachment"; while : ; do export ATTACHMENT_DONE=$(curl -s -H "Authorization: Bearer $(gcloud auth print-access-token)" -X GET "https://apigee.googleapis.com/v1/organizations/${GOOGLE_CLOUD_PROJECT}/instances/${INSTANCE_NAME}/attachments" | jq "select(.attachments != null) | .attachments[] | select(.environment == \"${ATTACHING_ENV}\") | .environment" --join-output); [[ "${ATTACHMENT_DONE}" != "${ATTACHING_ENV}" ]] || break; echo -n "."; sleep 5; done; echo; echo "***${ATTACHING_ENV} ENVIRONMENT ATTACHED***";
   ```

   When the text ***staging ENVIRONMENT ATTACHED*** is printed, proxies deployed to the staging environment can accept traffic.