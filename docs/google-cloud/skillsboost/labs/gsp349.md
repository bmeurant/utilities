# Deploy and Manage Apigee X: Challenge Lab

[GSP349](https://www.cloudskillsboost.google/focuses/20940?parent=catalog)

## Task 1. Modify the environments and environment groups

1. Create a **staging** environment
   - Navigate to [Apigee UI](https://console.cloud.google.com/apigee/overview/) in the Cloud console.
   - On the left navigation menu, select **Management > Environments**.
   - In the **Environments** tab, click **+ Create Environment**.
   - Specify **staging** for **Display name** and **Name**. Other fields should remain unchanged.
   - Click **Create**.

2. Create a **staging-group** environment group

   - On the left navigation menu, select **Management > Environments**.
   - In the Environments pane, select **Environment Groups** and click **+ Create Environment Group**.
   - Name the environment group **staging-group**.
   - Leave the default hostname that is created for the new environment group.
   - For the **Environments (Optional)** select **staging** and click **Ok**.
   - Click **Create**.   

## Task 2. Use the provisioning wizard to set up access routing

1. Set up **Access Routing**
   - Return to the **[wizard](https://apigee.google.com/setup)** Setup tab.
   - Next to **Access routing**, click **Edit**.
   - Select **Enable internet access**.
   - Select **Use wildcard DNS service**.
   - To use the default wildcard DNS provider, nip.io, leave the **domain** unchanged.
   - For **Subnetwork**, select **api-subnet**.
   - Click **Set Access** and wait until the access routing configuration has completed. 

2. Test the API
   - Run this command:

      ```bash
      export PROJECT_NAME=$(gcloud config get-value project)
      export SSL_HOSTNAME=$(curl -s -H "Authorization: Bearer $(gcloud auth print-access-token)" -X GET "https://compute.googleapis.com/compute/v1/projects/${PROJECT_NAME}/global/sslCertificates/apigee-ssl-cert" | jq ".managed.domains[0]" --raw-output)
      echo "SSL_HOSTNAME=${SSL_HOSTNAME}"
      curl -i "https://${SSL_HOSTNAME}/hello-world"
      ```

    - The response should look similar to this:

      ```json
         
      ```

## Task 3. Create and activate a NAT address for the instance

1. Create a **NAT address**

   - Copy the following Google API Explorer link and paste it in a new tab of your browser window for the Google Cloud Console: [Google APIs Explorer for the Apigee API](https://cloud.google.com/apigee/docs/reference/apis/apigee/rest).
   - In the left pane, expand the **organizations.instances.natAddresses** section.
   - Under **organizations.instances.natAddresses**, click **create**.
   - In the **Try this API** pane, set the **parent** to:

     ```text
     organizations/PROJECT/instances/eval-instance
     ```

     replace `PROJECT` with your project id

   - Click **Add request body parameters**, and then click **name**.
   - Between the double quotes, set the string to **apigee-nat-ip**.
   - Click **Execute**.

     If a window pops up and asks you to choose an account to continue to the Google API Explorer, select your lab username, and then click **Allow**.

   - The API response should resemble this:

     ```json
     {
       "name": "organizations/qwiklabs-gcp-01-f24706170325/operations/c79a19c8-ae9f-49de-978e-7f4873b06e51",
       "metadata": {
         "@type": "type.googleapis.com/google.cloud.apigee.v1.OperationMetadata",
         "operationType": "INSERT",
         "targetResourceName": "organizations/qwiklabs-gcp-01-f24706170325/instances/eval-instance/natAddresses/apigee-nat-ip",
         "state": "IN_PROGRESS"
       }
     }
     ```

   - In the left pane, under **organizations.instances.natAddresses**, click **get**.
   - In the **Try this API** pane, set the **parent** to:

     ```text
     organizations/PROJECT/instances/eval-instance/natAddresses/apigee-nat-ip
     ```

     replace `PROJECT` with your project id

   - Click **Execute**.

     If a window pops up and asks you to choose an account to continue to the Google API Explorer, select your lab user, and then click **Allow**.

   - The API response should resemble this:

     ```json
     {
       "name": "apigee-nat-ip",
       "ipAddress": "104.198.6.224",
       "state": "RESERVED"
     }
     ```

2. Activate the **NAT address**

    - In the left pane, under **organizations.instances.natAddresses**, click **activate**.
    - In the **Try this API** pane, set the **parent** to:

     ```text
     organizations/PROJECT/instances/eval-instance/natAddresses/apigee-nat-ip
     ```

     replace `PROJECT` with your project id

    - Click **Execute**.

     If a window pops up and asks you to choose an account to continue to the Google API Explorer, select your lab user, and then click **Allow**.

    - The API response should resemble this:

      ```json
      {
        "name": "organizations/qwiklabs-gcp-01-f24706170325/operations/4b96ee01-55a5-4824-859a-04c2e034d1d4",
        "metadata": {
          "@type": "type.googleapis.com/google.cloud.apigee.v1.OperationMetadata",
          "operationType": "INSERT",
          "targetResourceName": "organizations/qwiklabs-gcp-01-f24706170325/instances/eval-instance/natAddresses/apigee-nat-ip",
          "state": "IN_PROGRESS"
        }
      }
      ```

    - In the left pane, under **organizations.instances.natAddresses**, click **get**.
   - In the **Try this API** pane, set the **parent** to:

     ```text
     organizations/PROJECT/instances/eval-instance/natAddresses/apigee-nat-ip
     ```

     replace `PROJECT` with your project id

   - Click **Execute**.

     If a window pops up and asks you to choose an account to continue to the Google API Explorer, select your lab user, and then click **Allow**.

   - The API response should resemble this:

     ```json
     {
       "name": "apigee-nat-ip",
       "ipAddress": "104.198.6.224",
       "state": "ACTIVE"
     }

## Task 4. Create a Cloud Armor security policy and attach it to the global load balancer

1. Create the **Cloud Armor policy**

   - In the Cloud Console tab, on the Navigation menu, click **View all Products**, then select **Network security** in the **Networking** section, and then navigate to **Cloud Armor policies**.
   - Click **Create policy**.
   - For Name, specify **protect-apigee**.
   - For **Default rule action**, select **Allow**.
   - Click **Next Step**.

2. Add a rule to block Remote Code Execution attacks

   - Click **Add a Rule**.
   - Click **Advanced mode**.
   - For **Match**, specify the following expression:

     ```text
     evaluatePreconfiguredExpr('rce-stable')
     ```
   - Leave Action set to **Deny**, and leave **Deny status** set to **403 (Forbidden)**.
   - Set **Priority** to `1000`.
   - Click **SAVE CHANGE TO RULE**.
   - Click **Create policy**.

3. Attach the policy to the load balancer

    - Next to **protect-apigee**, click the policy menu button, and then click **Apply policy to target**.
    - Click **+ Add target**.
    - For the Backend Service 1 dropdown, select apigee-proxy-backend, and then click **Add**.

4. Test the API
   - Run this command:

      ```bash
      export PROJECT_NAME=$(gcloud config get-value project)
      export SSL_HOSTNAME=$(curl -s -H "Authorization: Bearer $(gcloud auth print-access-token)" -X GET "https://compute.googleapis.com/compute/v1/projects/${PROJECT_NAME}/global/sslCertificates/apigee-ssl-cert" | jq ".managed.domains[0]" --raw-output)
      echo "SSL_HOSTNAME=${SSL_HOSTNAME}"
      curl -i "https://${SSL_HOSTNAME}/hello-world?doc=/bin/ls
      ```

    - The response should look similar to this:

      ```json
         
      ```

## Task 5. Attach the staging environment to the runtime instance

1. Use the following Cloud Shell script to confirm that the Apigee runtime is completely installed and wait for `ORG IS READY TO USE`.

   ```bash
   export INSTANCE_NAME=eval-instance; export ENV_NAME=eval; export PREV_INSTANCE_STATE=; echo "waiting for runtime instance ${INSTANCE_NAME} to be active"; while : ; do export INSTANCE_STATE=$(curl -s -H "Authorization: Bearer $(gcloud auth print-access-token)" -X GET "https://apigee.googleapis.com/v1/organizations/${GOOGLE_CLOUD_PROJECT}/instances/${INSTANCE_NAME}" | jq "select(.state != null) | .state" --raw-output); [[ "${INSTANCE_STATE}" == "${PREV_INSTANCE_STATE}" ]] || (echo; echo "INSTANCE_STATE=${INSTANCE_STATE}"); export PREV_INSTANCE_STATE=${INSTANCE_STATE}; [[ "${INSTANCE_STATE}" != "ACTIVE" ]] || break; echo -n "."; sleep 5; done; echo; echo "instance created, waiting for environment ${ENV_NAME} to be attached to instance"; while : ; do export ATTACHMENT_DONE=$(curl -s -H "Authorization: Bearer $(gcloud auth print-access-token)" -X GET "https://apigee.googleapis.com/v1/organizations/${GOOGLE_CLOUD_PROJECT}/instances/${INSTANCE_NAME}/attachments" | jq "select(.attachments != null) | .attachments[] | select(.environment == \"${ENV_NAME}\") | .environment" --join-output); [[ "${ATTACHMENT_DONE}" != "${ENV_NAME}" ]] || break; echo -n "."; sleep 5; done; echo "***ORG IS READY TO USE***";
   ```

2. To begin the process of attaching the prod environment to the runtime, run the following command:

   ```bash
   export INSTANCE_NAME=eval-instance; curl -s -H "Authorization: Bearer $(gcloud auth print-access-token)" -H "Content-Type: application/json" -X POST "https://apigee.googleapis.com/v1/organizations/${GOOGLE_CLOUD_PROJECT}/instances/${INSTANCE_NAME}/attachments" -d '{ "environment": "staging" }' | jq
   ```

   When you have successfully begun the process of attaching the prod environment to the runtime, you should see a return message with a state of IN_PROGRESS looking similar to this:

   ```json
   {
    "name": "organizations/qwiklabs-gcp-00-f84c248124fe/operations/52e08ec5-cc65-4b4f-95ee-7b2323904616",
    "metadata": {
      "@type": "type.googleapis.com/google.cloud.apigee.v1.OperationMetadata",
      "operationType": "INSERT",
      "targetResourceName": "organizations/qwiklabs-gcp-00-f84c248124fe/instances/eval-instance/attachments/32ff43db-1756-4eb1-9024-525ea0eb877a",
      "state": "IN_PROGRESS"
    }
  }
   ```

3. Check the status of the staging attachment using this command:

   ```bash
   export ATTACHING_ENV=staging; export INSTANCE_NAME=eval-instance; echo "waiting for ${ATTACHING_ENV} attachment"; while : ; do export ATTACHMENT_DONE=$(curl -s -H "Authorization: Bearer $(gcloud auth print-access-token)" -X GET "https://apigee.googleapis.com/v1/organizations/${GOOGLE_CLOUD_PROJECT}/instances/${INSTANCE_NAME}/attachments" | jq "select(.attachments != null) | .attachments[] | select(.environment == \"${ATTACHING_ENV}\") | .environment" --join-output); [[ "${ATTACHMENT_DONE}" != "${ATTACHING_ENV}" ]] || break; echo -n "."; sleep 5; done; echo; echo "***${ATTACHING_ENV} ENVIRONMENT ATTACHED***";
   ```

   When the text ***staging ENVIRONMENT ATTACHED*** is printed, proxies deployed to the staging environment can accept traffic.