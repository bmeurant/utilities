# APIs with Apigee X: Challenge Lab

[GSP363](https://www.cloudskillsboost.google/focuses/32171?parent=catalog)

## Task 1. Proxy the Cloud Translation API

1. Enable Translation API

    ```bash
    gcloud services enable translate.googleapis.com
    ```

2. Create Service account and grant it the role **Logging > Logs Writer**

    ```bash
    gcloud iam service-accounts create apigee-proxy --display-name="Service account for Apigee proxy" --project=${GOOGLE_CLOUD_PROJECT}
    gcloud projects add-iam-policy-binding ${GOOGLE_CLOUD_PROJECT} --member="serviceAccount:apigee-proxy@${GOOGLE_CLOUD_PROJECT}.iam.gserviceaccount.com" --role="roles/logging.logWriter"
    ```
   
3. Create API Proxy

   - Navigate to [Apigee UI](https://console.cloud.google.com/apigee/overview/) in the Cloud console.
   - On the left navigation menu, select **Proxy development > API proxies**.
   - Create a new proxy using the proxy wizard, click **+ Create**.
   - For **Proxy template**, select **General template > Reverse proxy (Most common)**.
   - Specify the following for the **Proxy details**:

     | Property | Value |
     | :------ | :---- |
     | **Proxy Name** | `translate-v1` |
     | **Base Path** | `/translate/v1` |
     | **Target** | `https://translation.googleapis.com/language/translate/v2` |

   - Click Next, leave the other settings at their defaults, and click **Create**.

4. Add an Authentication section to the **default TargetEndpoint**

   - Click the **Develop** tab.
   - Under **Target endpoints** section, edit the *default.xml* file.
   - Under **HTTPTargetConnection**, **just below the URL, add:

     ```xml
     <Authentication>
       <GoogleAccessToken>
         <Scopes>
           <Scope>https://www.googleapis.com/auth/cloud-translation</Scope>
         </Scopes>
       </GoogleAccessToken>
     </Authentication>
     ```

5. Use the following Cloud Shell script to confirm that the Apigee runtime is completely installed and wait for `ORG IS READY TO USE`.

   ```bash
   export INSTANCE_NAME=eval-instance; export ENV_NAME=eval; export PREV_INSTANCE_STATE=; echo "waiting for runtime instance ${INSTANCE_NAME} to be active"; while : ; do export INSTANCE_STATE=$(curl -s -H "Authorization: Bearer $(gcloud auth print-access-token)" -X GET "https://apigee.googleapis.com/v1/organizations/${GOOGLE_CLOUD_PROJECT}/instances/${INSTANCE_NAME}" | jq "select(.state != null) | .state" --raw-output); [[ "${INSTANCE_STATE}" == "${PREV_INSTANCE_STATE}" ]] || (echo; echo "INSTANCE_STATE=${INSTANCE_STATE}"); export PREV_INSTANCE_STATE=${INSTANCE_STATE}; [[ "${INSTANCE_STATE}" != "ACTIVE" ]] || break; echo -n "."; sleep 5; done; echo; echo "instance created, waiting for environment ${ENV_NAME} to be attached to instance"; while : ; do export ATTACHMENT_DONE=$(curl -s -H "Authorization: Bearer $(gcloud auth print-access-token)" -X GET "https://apigee.googleapis.com/v1/organizations/${GOOGLE_CLOUD_PROJECT}/instances/${INSTANCE_NAME}/attachments" | jq "select(.attachments != null) | .attachments[] | select(.environment == \"${ENV_NAME}\") | .environment" --join-output); [[ "${ATTACHMENT_DONE}" != "${ENV_NAME}" ]] || break; echo -n "."; sleep 5; done; echo "***ORG IS READY TO USE***";
   ```

6. Save and deploy the proxy

   - Click **Save**.
   - Click **Deploy**.
   - For **Environment** select **eval**.
   - For **Service Account**, specify the service account's email address returned by:

     ```bash
     echo "apigee-proxy@${GOOGLE_CLOUD_PROJECT}.iam.gserviceaccount.com"
     ```

7. Test the API proxy

    - In Cloud Shell, open an SSH connection to apigeex-test-vm: 

      ```bash
      TEST_VM_ZONE=$(gcloud compute instances list --filter="name=('apigeex-test-vm')" --format "value(zone)")
      gcloud compute ssh apigeex-test-vm --zone=${TEST_VM_ZONE} --force-key-file-overwrite
      ```  

    - If asked to authorize, click **Authorize**. For each question asked in the gcloud command, click **Enter** or **Return** to specify the default input

    - Run the command:

      ```bash
      curl -i -k -X POST "https://eval.example.com/translate/v1" -H "Content-Type: application/json" -d '{ "q": "Translate this text!", "target": "es" }'
      ```

    - The response should look similar to this:

      ```json
      {
        "data": {
          "translations": [
            {
              "translatedText": "¡Traduce este texto!",
              "detectedSourceLanguage": "en"
            }
          ]
        }
      }
      ```
      

## Task 2. Change the API request and response

1. Create property set

   - In the Apigee navigation menu, select **Proxy development > API Proxies**, and then click **translate-v1**.
   - Click the **Develop** tab.
   - In the Navigator menu for the proxy, next to **Resources**, click +.
   - In the **Resource Type** dropdown, select **Property Set**.
   - Select **Create new file**
   - Specify `language.properties` for the Resource Name, and then click **Add**.
   - In the `language.properties` code pane, add the following property:
     
     ```text
     output=es
     caller=en
     ```

2. Create a flow for **POST** on `/`

   - In the left menu for the proxy, in the **Proxy endpoints** section, click **default**.
   - In the `proxy-endpoints/default.xml` pane, next to **Proxy endpoint: default /translate/v1**, click Add conditional flow (+ icon).
   - In the Add conditional flow dialog, specify the following values:

     | Property | Value |
     | :------ | :---- |
     | Flow name | **translate** |
     | Description | **translate** |
     | Condition type | `select Path and Verb` |
     | Path | `/` |
     | Verb | `select POST` |

   - Let Target URL emply and click **Add**. 

3. Create a flow for **GET** on `/languages`

   - In the left menu for the proxy, in the **Proxy endpoints** section, click **default**.
   - In the `proxy-endpoints/default.xml` pane, next to **Proxy endpoint: default /translate/v1**, click Add conditional flow (+ icon).
   - In the Add conditional flow dialog, specify the following values:

     | Property | Value |
     | :------ | :---- |
     | Flow name | **getLanguages** |
     | Description | **getLanguages** |
     | Condition type | `select Path` |
     | Path | `/languages` |

   - Let Target URL emply and click **Add**.

4. Create a **TranslateRequest policy** on `translate`

   - In the left menu for the proxy, in the **Proxy endpoints** under **default**, click **translate**.
   - In the Flow pane, click the + button right next to **translate** in the **request** flow.
   - Select **Create new Policy** and for **Select policy** dropdown, select **Assign Message** from the **Mediation** section, and then set the Display Name and Name to `AM-BuildTranslateRequest`.
   - Click **Add**. Click on `AM-BuildTranslateRequest` under Policies in the navigator menu.
   - Change the policy configuration to:

     ```xml
     <AssignMessage name="AM-BuildTranslateRequest">
       <AssignVariable>
         <Name>text</Name>
         <Template>{jsonPath($.text,request.content)}</Template>
       </AssignVariable>
       <AssignVariable>
         <Name>language</Name>
         <Template>{firstnonnull(request.queryparam.lang,propertyset.language.output)}</Template>
       </AssignVariable>
       <Set>
         <Payload>{ "q": "{text}", "target": "{language}" }</Payload>
       </Set>
       <IgnoreUnresolvedVariables>true</IgnoreUnresolvedVariables>
       <AssignTo createNew="false" transport="http" type="request"/>
     </AssignMessage>
     ```

5. Create a **TranslateResponse policy** on `translate`

   - In the left menu for the proxy, in the **Proxy endpoints** under **default**, click **translate**.
   - In the Flow pane, click the + button right next to **translate** in the **response** flow.
   - Select **Create new Policy** and for **Select policy** dropdown, select **Assign Message** from the **Mediation** section, and then set the Display Name and Name to `AM-BuildTranslateResponse`.
   - Click **Add**. Click on `AM-BuildTranslateResponse` under Policies in the navigator menu.
   - Change the policy configuration to:

     ```xml
     <AssignMessage name="AM-BuildTranslateResponse">
       <AssignVariable>
         <Name>translated</Name>
         <Template>{jsonPath($.data.translations[0].translatedText,response.content)}</Template>
       </AssignVariable>
       <Set>
         <Headers>
           <Header name="Content-Type">application/json</Header>
         </Headers>
         <Payload>{"translated": "{translated}" }</Payload>
       </Set>
       <IgnoreUnresolvedVariables>true</IgnoreUnresolvedVariables>
       <AssignTo createNew="true" transport="http" type="response"/>
     </AssignMessage>
     ```

6. Create a **BuildLanguagesRequest policy** on `getLanguages`

   - In the left menu for the proxy, in the **Proxy endpoints** under **default**, click **getLanguages**.
   - In the Flow pane, click the + button right next to **getLanguages** in the **request** flow.
   - Select **Create new Policy** and for **Select policy** dropdown, select **Assign Message** from the **Mediation** section, and then set the Display Name and Name to `AM-BuildLanguagesRequest`.
   - Click **Add**. Click on `AM-BuildLanguagesRequest` under Policies in the navigator menu.
   - Change the policy configuration to:

     ```xml
     <AssignMessage name="AM-BuildLanguagesRequest">
       <Set>
         <Verb>POST</Verb>
         <Payload contentType="application/json">{ "target": "{propertyset.language.caller}" }</Payload>
       </Set>
       <IgnoreUnresolvedVariables>true</IgnoreUnresolvedVariables>
       <AssignTo createNew="true" transport="http" type="request"/>
     </AssignMessage>
     ```

7. Create a **JavaScript policy** on `getLanguages`

   - In the left menu for the proxy, in the **Proxy endpoints** under **default**, click **getLanguages**.
   - In the Flow pane, click the + button right next to **getLanguages** in the **response** flow.
   - Select **Create new Policy** and for **Select policy** dropdown, select **Javascript** from the **Extension** section, and then set the Display Name and Name to `JS-BuildLanguagesResponse`.
   - For **JavaScript file**, click `Create New Resource`.
   - In the `Add resource` section, specify the following

     | Property | Value |
     | :------ | :---- |
     | Source | `select Create new file` |
     | Resource name | **buildLanguagesResponse.js** |

   - Click **Add**, and then select **buildLanguagesResponse.js**.
   - Let **Condition** empty, click **Add**, and then click **JS-BuildLanguagesResponse**.
   - In the left menu for the proxy, in the **Resources > jsc** section, click **buildLanguagesResponse.js**.
   - Add this JavaScript code to add the address to the response:

     ```javascript
     var payload = context.getVariable("response.content");
     var payloadObj = JSON.parse(payload);
     var newPayload = JSON.stringify(payloadObj.data.languages);
     context.setVariable("response.content", newPayload);
     ```

8. Save and deploy the proxy

   - Click **Save**.
   - Click **Save as new revision**.
   - Click **Deploy**.
   - For **Environment** select **eval**.
   - For **Service Account**, specify the service account's email address returned by:

     ```bash
     echo "apigee-proxy@${GOOGLE_CLOUD_PROJECT}.iam.gserviceaccount.com"
     ```

9. Test the API

    - In Cloud Shell, open an SSH connection to apigeex-test-vm: 

      ```bash
      TEST_VM_ZONE=$(gcloud compute instances list --filter="name=('apigeex-test-vm')" --format "value(zone)")
      gcloud compute ssh apigeex-test-vm --zone=${TEST_VM_ZONE} --force-key-file-overwrite
      ```  

    - If asked to authorize, click **Authorize**. For each question asked in the gcloud command, click **Enter** or **Return** to specify the default input

    - Run the command:

      ```bash
      curl -i -k -X GET "https://eval.example.com/translate/v1/languages"
      ```

    - The response should look similar to this:

      ```json
      [{"language":"ab","name":"Abkhaz"},{"language":"ace","name":"Acehnese"},{"language":"ach","name":"Acholi"},{"language":"af","name":"Afrikaans"},{"language":"sq","name":"Albanian"},{"language":"alz","name":"Alur"},...]
      
      ```

    - Run the command:

      ```bash
      curl -i -k -X POST "https://eval.example.com/translate/v1?lang=de" -H "Content-Type:application/json" -d '{ "text": "Hello world!" }'
      ```

    - The response should look similar to this:

      ```json
      {"translated": "Hallo Welt!" }      
      ```

    - Run the command:

      ```bash
      curl -i -k -X POST "https://eval.example.com/translate/v1" -H "Content-Type:application/json" -d '{ "text": "Hello world!" }'
      ```

    - The response should look similar to this:

      ```json
      {"translated": "¡Hola Mundo!" }      
      ```

## Task 3. Add API key verification and quota enforcement

1. Create a **Product**

   - On the Apigee navigation menu, select **Distribution > API Products**.
   - To create a new API product, click **+Create**.
   - In the **Product details** pane, specify the following:

     | Property | Value |
     | :------ | :---- |
     | Name | **translate-product** |
     | Display name | **Translate Product** |
     | Description | **allows to translate texts** |
     | Environment | *select* **eval** |
     | Access | *select* **Public** |

     Leave **Automatically approve access requests** selected.

2. Create an **Operation**

    - In the **Operations** section, click **+Add an Operation**.
    - Specify the following:

      | Property | Value |
      | :------ | :---- |
      | Source | *select the translate-vi API proxy* |
      | Path | **/** |
      | Methods | *select GET and POST* |

    - Set the operation's quota to **10 requests every 1 minute**, and click **Save** to save the operation.
    - Click **Save** to save the API product.

3. Create a **Developper**

   - On the Apigee navigation menu, click **Distribution > Developers**. 
   - To create a new app developer, click **+Create**.
   - Specify the following:

     | Property | Value |
     | :------ | :---- |
     | First Name | **Joe** |
     | Last Name | **Developer** |
     | Username | **joe** |
     | Email | **joe@example.com** |

4. Create an **App**

   - On the Apigee navigation menu, click **Distribution > Apps**.
   - To create a new app, click **+Create**.
   - In the **App details** pane, specify the following:

     | Property | Value |
     | :------ | :---- |
     | Name | **translate-app** |
     | Developer | *select joe@example.com* |

    - In the **Credentials** pane, click Add **credentials > Add products**, select **translate-product** from the drop-down, and then click **Add** to add.
    - Click **Create** to create the app.

5. Add a **VerifyKey** policy

   - In the Apigee navigation menu, select **Proxy development > API Proxies**, and then click **translate-v1**.
   - Click the **Develop** tab.
   - In the Navigator menu for the proxy, in the **Proxy Endpoints** section, click **PreFlow**.
   - In the Flow pane, click the + button right next to **PreFlow** in the **request** flow.
   - Select **Create new Policy** and for **Select policy** dropdown, select **Verify API Key** from the **Security** section, and then set the **Display Name** and **Name** to `VAK-VerifyKey`.
   - Click **Add**. Click on `VAK-VerifyKey` under Policies in the navigator menu.
   - Change the policy configuration to:

     ```xml
     <VerifyAPIKey continueOnError="false" enabled="true" name="VA-VerifyKey">
       <DisplayName>VA-VerifyKey</DisplayName>
       <Properties/>
       <APIKey ref="request.header.Key"/>
     </VerifyAPIKey>
     ```

6. Add a **Quota** policy

   - In the Apigee navigation menu, select **Proxy development > API Proxies**, and then click **translate-v1**.
   - Click the **Develop** tab.
   - In the Navigator menu for the proxy, in the **Proxy Endpoints** section, click **PreFlow**.
   - In the Flow pane, click the + button right next to **PreFlow** in the **request** flow.
   - Select **Create new Policy** and for **Select policy** dropdown, select **Quota** from the **Traffic Management** section, and then set the **Display Name** and **Name** to `Q-EnforceQuota`.
   - Click **Add**. Click on `Q-EnforceQuota` under Policies in the navigator menu.
   - Change the policy configuration to:

     ```xml
     <Quota continueOnError="false" enabled="true" name="Q-EnforceQuota" type="calendar">
       <UseQuotaConfigInAPIProduct stepName="VA-VerifyKey">
         <DefaultConfig>
           <Allow>5</Allow>
           <Interval>1</Interval>
           <TimeUnit>hour</TimeUnit>
         </DefaultConfig>
       </UseQuotaConfigInAPIProduct>
       <Distributed>true</Distributed>
       <Synchronous>true</Synchronous>
       <StartTime>2022-01-01 00:00:00</StartTime>
     </Quota>
     ```

7. Save and deploy the proxy

   - Click **Save**.
   - Click **Save as new revision**.
   - Click **Deploy**.
   - For **Environment** select **eval**.
   - For **Service Account**, specify the service account's email address returned by:

     ```bash
     echo "apigee-proxy@${GOOGLE_CLOUD_PROJECT}.iam.gserviceaccount.com"
     ```

8. Test the API

    - In Cloud Shell, open an SSH connection to apigeex-test-vm: 

      ```bash
      TEST_VM_ZONE=$(gcloud compute instances list --filter="name=('apigeex-test-vm')" --format "value(zone)")
      gcloud compute ssh apigeex-test-vm --zone=${TEST_VM_ZONE} --force-key-file-overwrite
      ```  

    - If asked to authorize, click **Authorize**. For each question asked in the gcloud command, click **Enter** or **Return** to specify the default input

    - Fails (no API key):

      ```bash
      curl -i -k -X POST "https://eval.example.com/translate/v1?lang=de" -H "Content-Type:application/json" -d '{ "text": "Hello world!" }'
      ```

    - The response should look similar to this:

      ```json
      {"fault":{"faultstring":"Failed to resolve API Key variable request.header.Key","detail":{"errorcode":"steps.oauth.v2.FailedToResolveAPIKey"}}}      
      ```

    - Fails (invalid API key):

      ```bash
      curl -i -k -X POST "https://eval.example.com/translate/v1?lang=de" -H "Content-Type:application/json" -H "Key: ABC123" -d '{ "text": "Hello world!" }'
      ```

    - The response should look similar to this:

      ```json
      {"fault":{"faultstring":"Invalid ApiKey","detail":{"errorcode":"oauth.v2.InvalidApiKey"}}      
      ```

    - Succeeds (when KEY variable is set to a valid API key):

      ```bash
      export KEY=<get this from the earlier step when setting up a Developer App>
      curl -i -k -X POST "https://eval.example.com/translate/v1?lang=de" -H "Content-Type:application/json" -H "Key: $KEY" -d '{ "text": "Hello world!" }'
      ```

    - The response should look similar to this:

      ```json
      {"translated": "Hallo Welt!" }      
      ```

## Task 4. Add message logging

1. Add a **MessageLoging** policy

   - In the Apigee navigation menu, select **Proxy development > API Proxies**, and then click **translate-v1**.
   - Click the **Develop** tab.
   - In the left menu for the proxy, in the **Proxy endpoints** under **default**, click **translate**.
   - In the Flow pane, click the + button right next to **translate** in the **response** flow.
   - Select **Create new Policy** and for **Select policy** dropdown, select **Message Logging** from the **Extension** section, and then set the Display Name and Name to `ML-LogTranslation`.
   - Click **Add**. Click on `ML-LogTranslation` under Policies in the navigator menu.
   - Change the policy configuration to:

     ```xml
     <MessageLogging name="ML-LogTranslation">
       <CloudLogging>
         <LogName>projects/{organization.name}/logs/translate</LogName>
         <Message contentType="text/plain">{language}|{text}|{translated}</Message>
       </CloudLogging>
     </MessageLogging>
     ```

2. Save and deploy the proxy

   - Click **Save**.
   - Click **Save as new revision**
   - Click **Deploy**.
   - For **Environment** select **eval**.
   - For **Service Account**, specify the service account's email address returned by:

     ```bash
     echo "apigee-proxy@${GOOGLE_CLOUD_PROJECT}.iam.gserviceaccount.com"
     ```

3. Test the API

    - In Cloud Shell, open an SSH connection to apigeex-test-vm: 

      ```bash
      TEST_VM_ZONE=$(gcloud compute instances list --filter="name=('apigeex-test-vm')" --format "value(zone)")
      gcloud compute ssh apigeex-test-vm --zone=${TEST_VM_ZONE} --force-key-file-overwrite
      ```  

    - If asked to authorize, click **Authorize**. For each question asked in the gcloud command, click **Enter** or **Return** to specify the default input

    - Validate the logged messages in the **Logging** page of the Google Cloud Console. Use the query `logName : "translate"` to see only the translated logs.

    - Run this command:
    
      ```bash
      curl -i -k -X POST "https://eval.example.com/translate/v1?lang=de" -H "Content-Type:application/json" -H "Key: $KEY" -d '{ "text": "Hello world!" }'
      ```

    - That curl command should create a log message with the following contents

      ```text
      de|Hello world!|Hallo Welt!
      ```

## Task 5. Rewrite a backend error message

1. Add a **BuildErrorResponse** policy

   - In the Apigee navigation menu, select **Proxy development > API Proxies**, and then click **translate-v1**.
   - Click the **Develop** tab.
   - In the Navigator menu for the proxy, next to **Policies**, click **+**.
   - Select **Assign Message** from the **Mediation** section, and then set the Display Name and Name to `AM-BuildErrorResponse`.
   - Click **Add**. Click on `AM-BuildErrorResponse` under Policies in the navigator menu.
   - Change the policy configuration to:

     ```xml
     <AssignMessage name="AM-BuildErrorResponse">
       <Set>
           <Payload contentType="application/json">{ "error": "Invalid request. Verify the lang query parameter." }</Payload>
       </Set>
     </AssignMessage>
     ```

2. Add a **FaultRule** section

   - In the Navigator menu for the proxy, in the **Target endpoints** section, click **default**.
   - In the TargetEndpoint configuration, directly under the TargetEndpoint tag, replace the <FaulRule/> section with the following *FaultRules* section:

     ```xml
     <FaultRules>
       <FaultRule name="invalidInput">
         <Step>
           <Name>AM-BuildErrorResponse</Name>
         </Step>
         <Condition>fault.name == "ErrorResponseCode"</Condition>
       </FaultRule>
     </FaultRules>
     ```

3. Save and deploy the proxy

   - Click **Save**.
   - Click **Deploy**.
   - For **Environment** select **eval**.
   - For **Service Account**, specify the service account's email address returned by:

     ```bash
     echo "apigee-proxy@${GOOGLE_CLOUD_PROJECT}.iam.gserviceaccount.com"
     ```

4. Test the API

    - In Cloud Shell, open an SSH connection to apigeex-test-vm: 

      ```bash
      TEST_VM_ZONE=$(gcloud compute instances list --filter="name=('apigeex-test-vm')" --format "value(zone)")
      gcloud compute ssh apigeex-test-vm --zone=${TEST_VM_ZONE} --force-key-file-overwrite
      ```  

    - If asked to authorize, click **Authorize**. For each question asked in the gcloud command, click **Enter** or **Return** to specify the default input
    - Valid request:
    
      ```bash
      curl -i -k -X POST "https://eval.example.com/translate/v1?lang=de" -H "Content-Type:application/json" -H "Key: $KEY" -d '{ "text": "Hello world!" }'
      ```

    - The response should look similar to this:

      ```json
      {"translated": "Hallo Welt!" }      
      ```

    - invalid language query parameter:
    
      ```bash
      curl -i -k -X POST "https://eval.example.com/translate/v1?lang=invalid" -H "Content-Type:application/json" -H "Key: $KEY" -d '{ "text": "Hello world!" }'
      ```

    - The response should look similar to this:

      ```json
      { "error": "Invalid request. Verify the lang query parameter." }
      ```